<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.besto.tms.mapper.ExamineMapper" >
  <resultMap id="BaseResultMap" type="com.besto.tms.po.Examine" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 12 14:27:52 CST 2015.
    -->
    <id column="primaryid" property="primaryid" jdbcType="BIGINT" />
    <result column="examinecorrelateid" property="examinecorrelateid" jdbcType="VARCHAR" />
    <result column="examinecorrelatetype" property="examinecorrelatetype" jdbcType="VARCHAR" />
    <result column="userid" property="userid" jdbcType="VARCHAR" />
    <result column="username" property="username" jdbcType="VARCHAR" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="submittime" property="submittime" jdbcType="VARCHAR" />
    <result column="taskdistribution" property="taskdistribution" jdbcType="VARCHAR" />
    <result column="examinetype" property="examinetype" jdbcType="VARCHAR" />
    <result column="examinestatus" property="examinestatus" jdbcType="VARCHAR" />
    <result column="downobjection" property="downobjection" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 12 14:27:52 CST 2015.
    -->
    primaryid, examinecorrelateid, examinecorrelatetype, userid, username, title, submittime, 
    taskdistribution, examinetype, examinestatus, downobjection
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 12 14:27:52 CST 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from ma_examine
    where primaryid = #{primaryid,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 12 14:27:52 CST 2015.
    -->
    delete from ma_examine
    where primaryid = #{primaryid,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.besto.tms.po.Examine" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 12 14:27:52 CST 2015.
    -->
    insert into ma_examine (primaryid, examinecorrelateid, examinecorrelatetype, 
      userid, username, title, 
      submittime, taskdistribution, examinetype, 
      examinestatus, downobjection)
    values (#{primaryid,jdbcType=BIGINT}, #{examinecorrelateid,jdbcType=VARCHAR}, #{examinecorrelatetype,jdbcType=VARCHAR}, 
      #{userid,jdbcType=VARCHAR}, #{username,jdbcType=VARCHAR}, #{title,jdbcType=VARCHAR}, 
      #{submittime,jdbcType=VARCHAR}, #{taskdistribution,jdbcType=VARCHAR}, #{examinetype,jdbcType=VARCHAR}, 
      #{examinestatus,jdbcType=VARCHAR}, #{downobjection,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.besto.tms.po.Examine" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 12 14:27:52 CST 2015.
    -->
    insert into ma_examine
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="primaryid != null" >
        primaryid,
      </if>
      <if test="examinecorrelateid != null" >
        examinecorrelateid,
      </if>
      <if test="examinecorrelatetype != null" >
        examinecorrelatetype,
      </if>
      <if test="userid != null" >
        userid,
      </if>
      <if test="username != null" >
        username,
      </if>
      <if test="title != null" >
        title,
      </if>
      <if test="submittime != null" >
        submittime,
      </if>
      <if test="taskdistribution != null" >
        taskdistribution,
      </if>
      <if test="examinetype != null" >
        examinetype,
      </if>
      <if test="examinestatus != null" >
        examinestatus,
      </if>
      <if test="downobjection != null" >
        downobjection,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="primaryid != null" >
        #{primaryid,jdbcType=BIGINT},
      </if>
      <if test="examinecorrelateid != null" >
        #{examinecorrelateid,jdbcType=VARCHAR},
      </if>
      <if test="examinecorrelatetype != null" >
        #{examinecorrelatetype,jdbcType=VARCHAR},
      </if>
      <if test="userid != null" >
        #{userid,jdbcType=VARCHAR},
      </if>
      <if test="username != null" >
        #{username,jdbcType=VARCHAR},
      </if>
      <if test="title != null" >
        #{title,jdbcType=VARCHAR},
      </if>
      <if test="submittime != null" >
        #{submittime,jdbcType=VARCHAR},
      </if>
      <if test="taskdistribution != null" >
        #{taskdistribution,jdbcType=VARCHAR},
      </if>
      <if test="examinetype != null" >
        #{examinetype,jdbcType=VARCHAR},
      </if>
      <if test="examinestatus != null" >
        #{examinestatus,jdbcType=VARCHAR},
      </if>
      <if test="downobjection != null" >
        #{downobjection,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.besto.tms.po.Examine" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 12 14:27:52 CST 2015.
    -->
    update ma_examine
    <set >
      <if test="examinecorrelateid != null" >
        examinecorrelateid = #{examinecorrelateid,jdbcType=VARCHAR},
      </if>
      <if test="examinecorrelatetype != null" >
        examinecorrelatetype = #{examinecorrelatetype,jdbcType=VARCHAR},
      </if>
      <if test="userid != null" >
        userid = #{userid,jdbcType=VARCHAR},
      </if>
      <if test="username != null" >
        username = #{username,jdbcType=VARCHAR},
      </if>
      <if test="title != null" >
        title = #{title,jdbcType=VARCHAR},
      </if>
      <if test="submittime != null" >
        submittime = #{submittime,jdbcType=VARCHAR},
      </if>
      <if test="taskdistribution != null" >
        taskdistribution = #{taskdistribution,jdbcType=VARCHAR},
      </if>
      <if test="examinetype != null" >
        examinetype = #{examinetype,jdbcType=VARCHAR},
      </if>
      <if test="examinestatus != null" >
        examinestatus = #{examinestatus,jdbcType=VARCHAR},
      </if>
      <if test="downobjection != null" >
        downobjection = #{downobjection,jdbcType=VARCHAR},
      </if>
      <if test="assignstatus != null" >
        assignStatus = #{assignstatus,jdbcType=VARCHAR},
      </if>
      
       <if test="examineuserid != null" >
        displayuserid = #{examineuserid,jdbcType=VARCHAR},
      </if>
      
       <if test="examineusername != null" >
        displayusername = #{examineusername,jdbcType=VARCHAR},
      </if>
      
    </set>
    where primaryid = #{primaryid,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.besto.tms.po.Examine" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 12 14:27:52 CST 2015.
    -->
    update ma_examine
    set examinecorrelateid = #{examinecorrelateid,jdbcType=VARCHAR},
      examinecorrelatetype = #{examinecorrelatetype,jdbcType=VARCHAR},
      userid = #{userid,jdbcType=VARCHAR},
      username = #{username,jdbcType=VARCHAR},
      title = #{title,jdbcType=VARCHAR},
      submittime = #{submittime,jdbcType=VARCHAR},
      taskdistribution = #{taskdistribution,jdbcType=VARCHAR},
      examinetype = #{examinetype,jdbcType=VARCHAR},
      examinestatus = #{examinestatus,jdbcType=VARCHAR},
      downobjection = #{downobjection,jdbcType=VARCHAR}
    where primaryid = #{primaryid,jdbcType=BIGINT}
  </update>
  <select id="getTotalRows" resultType="java.lang.Integer" parameterType="com.besto.tms.vo.ExamineVO">    
        SELECT count(*) from (
        	SELECT DISTINCT m.provider as providerid,m.primaryid,m.examinecorrelateid,m.examinecorrelatetype,m.userid,m.username,
    		                m.title,m.submittime,m.taskdistribution,m.examinetype,m.examinestatus,m.downobjection,m.assignStatus,m.displayuserid,
    		                m.displayusername,m.series_id,m.playurls,m.provider,IFNULL(pro.timelength,0) as timelength from (
        	select m.*,v.playurl as playurls,'0' as series_id,cm.category_id,c.provider from (SELECT * from ma_examine m2 where m2.examinecorrelatetype != 9 and m2.examinestatus=0) m left outer join ma_programmoviemapping p on m.examinecorrelateid = p.program_id
        	left outer join ma_movie v on p.movie_id = v.id
        	left outer join users u on m.userid = u.userid 
			left outer join cpinfo c on u.cspid = c.cspid
			<!-- 点播内容 -->
			<if test="actiontype!=null and actiontype!='' and actiontype==1">
			 left outer join ma_categoryprogrammapping cm on cm.program_id=m.examinecorrelateid
			 left outer join ma_category cate on cm.category_id=cate.id
				
				<!-- UNION ALL 子集审核信息 -->
				UNION ALL
				SELECT m.*,v1.playurl AS playurls,cm1.category_id,c1.provider from 
				(SELECT m1.*,sp.series_id from ma_examine m1,ma_seriesprogrammapping sp where m1.examinecorrelateid=sp.program_id and m1.examinecorrelatetype=9 and m1.examinestatus = 0 ) m
				LEFT OUTER JOIN ma_programmoviemapping p1 ON m.examinecorrelateid = p1.program_id
				LEFT OUTER JOIN ma_movie v1 ON p1.movie_id = v1.id
				LEFT OUTER JOIN users u1 ON m.userid = u1.userid
				LEFT OUTER JOIN cpinfo c1 ON u1.cspid = c1.cspid
				LEFT OUTER JOIN ma_categoryprogrammapping cm1 ON cm1.program_id = m.series_id 
				LEFT OUTER JOIN ma_category cate1 ON cm1.category_id = cate1.id
			 
			 
			</if>
			<!-- 直播、广播内容 -->
			<if test="actiontype!=null and actiontype!='' and (actiontype==2 or actiontype==6)">
				left outer join ma_categorychannelmapping cm on cm.channel_id=m.examinecorrelateid
				left outer join ma_category cate on cm.category_id=cate.id
			</if>
			<!-- 节目单 -->
			<if test="actiontype!=null and actiontype!='' and (actiontype==3 or actiontype==7)">
				left outer join ma_categoryschedulemapping cm on cm.schedule_id=m.examinecorrelateid
				left outer join ma_category cate on cm.category_id=cate.id
			</if>
			<!-- 分类管理 -->
			<if test="actiontype!=null and actiontype!='' and actiontype==4">
				left outer join ma_category cate on cate.primaryid=m.examinecorrelateid 
				left outer join (select cc.primaryid as category_id,cc.primaryid from ma_category cc where cc.parentid=#{category_id}) cm on cm.primaryid=cate.parentid 
			</if>
			) m


			<if test="actiontype!=null and actiontype!='' and actiontype==4">
				LEFT OUTER JOIN (select 1 as id,0 as timelength,'' AS providerid from dual) pro ON pro.id =m.examinecorrelateid
			</if>
			<if test="actiontype!=null and actiontype!='' and actiontype!=4">
				LEFT OUTER JOIN ma_program pro ON pro.id =m.examinecorrelateid
			</if>
			
        	<where>
        	   1=1 
        	   <if test="actiontype!=null and actiontype!='' and actiontype==1">
        	   		and m.examinecorrelatetype in ('1','2','9')
        	   </if>
        	   <if test="actiontype!=null and actiontype!='' and actiontype==2">
        	   		and m.examinecorrelatetype in ('0','3')
        	   </if>
        	   <if test="actiontype!=null and actiontype!='' and actiontype==3">
        	   		and m.examinecorrelatetype='8'
        	   </if>
        	    <if test="actiontype!=null and actiontype!='' and actiontype==4">
        	   		and m.examinecorrelatetype in ('4','5','6','7')
        	   </if>
        	   
        	   <!-- 内容审核 -->
        	   <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='content' ">
        	   		and m.examinetype in ('4')
        	   </if>
        	   <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='work' ">
        	   		and m.examinetype in ('0','1','2','3')
        	   </if>
        	    <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='all' ">

        	   </if>
        	   <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='not' ">
					and m.examinetype in ('-1')
        	   </if>
        	   
			  <!-- 动态拼接条件 注意like 查询 符号变化   -->
			  <if test="cspids!=null and cspids!='MAS' and cspids!=''">
				 and  pro.providerid = #{cspids}
			  </if>
			  <if test="username!=null and username!='' ">
				 and  m.username like '%${username}%' ESCAPE'|' 
			  </if>
			  <if test="title!=null and title!='' ">
				 and  m.title like  '%${title}%' ESCAPE'|' 
			  </if>
			  <if  test="submitstarttime!=null and submitstarttime!='' ">
			     <![CDATA[ AND m.submittime >= #{submitstarttime,jdbcType=VARCHAR} ]]> 
			  </if>
			  <if test="submitendtime!=null and submitendtime!=''">
			     <![CDATA[ AND m.submittime <=  #{submitendtime,jdbcType=VARCHAR}  ]]> 
			  </if>
			<if test="actiontype!=null and actiontype!='' and actiontype==1">
				<if test="assignstatus!=null and assignstatus!='' ">
					<if test="assignstatus!=null and assignstatus!=3">
						AND ( m. assignstatus!=3 or isNULL( m. assignstatus))
					</if>
					<if test="assignstatus!=null and assignstatus==3">
				 		AND m. assignstatus=3
				 	</if>
			  	</if>
				
			  	 <if test="taskList != null and taskList.size()>0" >
					AND
					<foreach collection="taskList" item="item" open="(" separator="or" close=")">
						(  
						 <if test="item!=null and item!='' and level>= item ">
							<!-- 各级审批无指派策略时 -->
							<!-- 一级审批无指派策略或是终审时 -->
							<if  test="(item==1) " >
								 m.taskdistribution =1
							</if>
							<!-- 一级审批通过，未指派 --> 
							<if  test="item==1 and assigned1==1 " >
								 or (m.taskdistribution=2  and (m.assignStatus !=3 or ISNULL(m.assignstatus)) and displayuserid=#{handling_userid} )  
							</if>
							


							<!-- 二级审批    一级审批无指派策略或是终审时 -->
							<if  test="(item==2 and assigned1!=1) " >
								 m.taskdistribution =2
							</if>
							<!-- 二级审批，一审指派的 --> 
							<if  test="item==2 and assigned1==1 " >
								<if  test="(item==2 and assigned1!=1) " >
								or
								</if>	
								 (m.taskdistribution=2  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							<!-- 二级审批通过，未指派 --> 
							<if  test="item==2 and assigned2==1 " >
								<if  test="(item==2 and assigned1!=1)  or (item==2 and assigned1==1) " >
									or
								</if>
								 (m.taskdistribution=3  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							
							
							
							<!-- 三级审批　二级审批无指派策略或是终审时 -->
							<if  test="(item==3 and assigned2!=1) " >
								 m.taskdistribution =3
							</if>
							<!-- 三级审批，二审指派的 --> 
							<if  test="item==3 and assigned2==1" >
								<if  test="(item==3 and assigned2!=1) " >
									or 
								</if>
								 (m.taskdistribution=3  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							<!-- 三级审批通过，未指派 --> 
							<if  test="item==3 and assigned3==1" >
								<if  test="(item==3 and assigned2!=1) or (item==3 and assigned2==1) " >
									or 
								</if>
								 (m.taskdistribution=4  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							
							
							<!-- 四级审批　三级审批无指派策略或是终审时 -->
							<if  test="(item==4 and assigned3!=1) " >
								 m.taskdistribution =4
							</if>
							<!-- 四级审批，三审指派的 --> 
							<if  test="item==4 and assigned3==1" >
								<if  test="(item==4 and assigned3!=1) " >
									or
								</if>
								 (m.taskdistribution=4  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							<!-- 四级审批通过，未指派 --> 
							<if  test="item==4 and assigned4==1" >
								<if  test="(item==4 and assigned3!=1) or (item==4 and assigned3==1) " >
									or 
								</if>	
								 (m.taskdistribution=5  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							
							
							
							
							<!-- 五级审批　四级审批无指派策略或是终审时 -->
							<if  test="(item==5 and assigned4!=1) " >
								 m.taskdistribution =5
							</if>
							<!-- 五级审批，四审指派的 --> 
							<if  test="item==5 and assigned4==1" >
								<if  test="(item==5 and assigned4!=1) " >
									or
								</if>
								 (m.taskdistribution=5  and m.(m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							
							
							
						</if>
						
						)
					</foreach>
				 </if>
			  </if>
			  
			  <if test="actiontype!=null and actiontype!='' and actiontype!=1">
				  
				  <if test="taskList != null and taskList.size()>0" >
					 AND  m.taskdistribution  IN  
					<foreach collection="taskList" item="item" open="(" separator="," close=")">
						#{item}
					</foreach>
				 </if>
			 </if>
			
			
				AND m.examinestatus = 0
				
				 <if test="actiontype!=null and actiontype!='' and actiontype!=4">
				  	<if test="category_code!=null and category_code!='' ">
						and m.category_id in (${category_code})
					</if>
				</if>	
		   </where>
		) cc 
    </select>
     <!-- 分页查询例子 --> 
    <select id="searchPage"  resultType="com.besto.tms.vo.ExamineVO"   parameterType="com.besto.tms.vo.ExamineVO" >
    		SELECT DISTINCT cp.cpname as providerid,m.primaryid,m.examinecorrelateid,m.examinecorrelatetype,m.userid,m.username,
    		                m.title,m.submittime,m.taskdistribution,m.examinetype,m.examinestatus,m.downobjection,m.assignStatus,m.displayuserid,
    		                m.displayusername,m.series_id,m.playurls,cp.cpname as provider,IFNULL(pro.timelength,0) as timelength  from (
        	select m.*,'0' as series_id,v.playurl as playurls,cm.category_id<!-- ,c.cpname as provider --> from (SELECT * from ma_examine m2 where m2.examinecorrelatetype != 9 and m2.examinestatus=0) m left outer join ma_programmoviemapping p on m.examinecorrelateid = p.program_id
        	left outer join ma_movie v on p.movie_id = v.id
        	left outer join users u on m.userid = u.userid 
<!-- 			left outer join cpinfo c on u.cspid = c.cspid -->
			<!-- 点播内容 -->
			<if test="actiontype!=null and actiontype!='' and actiontype==1">
			 left outer join ma_categoryprogrammapping cm on cm.program_id=m.examinecorrelateid
			 left outer join ma_category cate on cm.category_id=cate.id
<!-- 			 LEFT OUTER JOIN ma_program pro ON pro.id =m.examinecorrelateid	 -->
				<!-- UNION ALL 子集审核信息 -->
				UNION ALL
				SELECT m.*,v1.playurl AS playurls, cm1.category_id <!--,c1.cpname as provider  ,IFNULL(pro1.timelength,0) as timelength  --> from 
				(SELECT m1.*,sp.series_id from ma_examine m1,ma_seriesprogrammapping sp where m1.examinecorrelateid=sp.program_id and m1.examinecorrelatetype=9 and m1.examinestatus = 0 ) m
				LEFT OUTER JOIN ma_programmoviemapping p1 ON m.examinecorrelateid = p1.program_id
				LEFT OUTER JOIN ma_movie v1 ON p1.movie_id = v1.id
				LEFT OUTER JOIN users u1 ON m.userid = u1.userid
<!-- 				LEFT OUTER JOIN cpinfo c1 ON u1.cspid = c1.cspid -->
				LEFT OUTER JOIN ma_categoryprogrammapping cm1 ON cm1.program_id = m.series_id 
				LEFT OUTER JOIN ma_category cate1 ON cm1.category_id = cate1.id
<!-- 			 	LEFT OUTER JOIN ma_program pro1 ON pro1.id =m.examinecorrelateid -->
			 
			</if>
			<!-- 直播、广播内容 -->
			<if test="actiontype!=null and actiontype!='' and (actiontype==2 or actiontype==6)">
				left outer join ma_categorychannelmapping cm on cm.channel_id=m.examinecorrelateid
				left outer join ma_category cate on cm.category_id=cate.id
				<!-- 为了显示时长 -->
				<!-- LEFT OUTER JOIN ma_program pro ON pro.id =m.examinecorrelateid -->
			</if>
			<!-- 节目单 -->
			<if test="actiontype!=null and actiontype!='' and (actiontype==3 or actiontype==7)">
				left outer join ma_categoryschedulemapping cm on cm.schedule_id=m.examinecorrelateid
				left outer join ma_category cate on cm.category_id=cate.id
				<!-- 为了显示时长 -->
				<!-- LEFT OUTER JOIN ma_program pro ON pro.id =m.examinecorrelateid -->
			</if>
			<!-- 分类管理 -->
			<if test="actiontype!=null and actiontype!='' and actiontype==4">
				left outer join ma_category cate on cate.primaryid=m.examinecorrelateid 
				left outer join (select cc.id as category_id,cc.primaryid from ma_category cc  where cc.parentid=#{category_id}) cm on cm.primaryid=cate.parentid 
				<!-- 为了显示时长 -->
				<!-- LEFT OUTER JOIN (select 1 as id,0 as timelength from dual) pro ON pro.id =m.examinecorrelateid -->
			</if>
			) m

			<if test="actiontype!=null and actiontype!='' and actiontype==4">
				LEFT OUTER JOIN (select 1 as id,0 as timelength,'' AS providerid from dual) pro ON pro.id =m.examinecorrelateid
			</if>
			<if test="actiontype!=null and actiontype!='' and actiontype!=4">
				LEFT OUTER JOIN ma_program pro ON pro.id =m.examinecorrelateid
			</if>
				LEFT JOIN cpinfo cp ON pro.providerid = cp.provider
			
			
			
			
				
        	<where>
        	   1=1 
        	   <if test="actiontype!=null and actiontype!='' and actiontype==1">
        	   		and m.examinecorrelatetype in ('1','2','9')
        	   </if>
        	   <if test="actiontype!=null and actiontype!='' and actiontype==2">
        	   		and m.examinecorrelatetype in ('0','3')
        	   </if>
        	   <if test="actiontype!=null and actiontype!='' and actiontype==3">
        	   		and m.examinecorrelatetype='8'
        	   </if>
        	    <if test="actiontype!=null and actiontype!='' and actiontype==4">
        	   		and m.examinecorrelatetype in ('4','5','6','7')
        	   </if>
        	   
        	   <!-- 内容审核 -->
        	   <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='content' ">
        	   		and m.examinetype in ('4')
        	   </if>
        	   <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='work' ">
        	   		and m.examinetype in ('0','1','2','3')
        	   </if>
        	    <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='all' ">

        	   </if>
        	   <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='not' ">
					and m.examinetype in ('-1')
        	   </if>
        	   
			  <!-- 动态拼接条件 注意like 查询 符号变化   -->
			  <if test="cspids!=null and cspids!='MAS' and cspids!=''">
				 AND  pro.providerid = #{cspids}  
			  </if>
			  <if test="username!=null and username!='' ">
				 and  m.username like '%${username}%' ESCAPE'|' 
			  </if>
			  <if test="title!=null and title!='' ">
				 and  m.title like  '%${title}%' ESCAPE'|' 
			  </if>
			  <if  test="submitstarttime!=null and submitstarttime!='' ">
			     <![CDATA[ AND m.submittime >= #{submitstarttime,jdbcType=VARCHAR} ]]> 
			  </if>
			  <if test="submitendtime!=null and submitendtime!=''">
			     <![CDATA[ AND m.submittime <=  #{submitendtime,jdbcType=VARCHAR}  ]]> 
			  </if>
			  <!-- 点播指派 -->
			  <if test="actiontype!=null and actiontype!='' and actiontype==1">
				
				
				<if test="assignstatus!=null and assignstatus!='' ">
					<if test="assignstatus!=null and assignstatus!=3">
						AND ( m. assignstatus!=3 or isNULL( m. assignstatus))
					</if>
					<if test="assignstatus!=null and assignstatus==3">
				 		AND m. assignstatus=3
				 	</if>
			  	</if>
				
				
				
				
				
			  	 <if test="taskList != null and taskList.size()>0" >
					AND
					<foreach collection="taskList" item="item" open="(" separator="or" close=")">
						(  
						 <if test="item!=null and item!='' and level>= item ">
							<!-- 各级审批无指派策略时 -->
							<!-- 一级审批无指派策略或是终审时 -->
							<if  test="(item==1) " >
								 m.taskdistribution =1
							</if>
							<!-- 一级审批通过，未指派 --> 
							<if  test="item==1 and assigned1==1 " >
								 or (m.taskdistribution=2  and (m.assignStatus !=3 or ISNULL(m.assignstatus)) and displayuserid=#{handling_userid} )  
							</if>
							


							<!-- 二级审批    一级审批无指派策略或是终审时 -->
							<if  test="(item==2 and assigned1!=1) " >
								 m.taskdistribution =2
							</if>
							<!-- 二级审批，一审指派的 --> 
							<if  test="item==2 and assigned1==1 " >
								<if  test="(item==2 and assigned1!=1) " >
								or
								</if>	
								 (m.taskdistribution=2  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							<!-- 二级审批通过，未指派 --> 
							<if  test="item==2 and assigned2==1 " >
								<if  test="(item==2 and assigned1!=1)  or (item==2 and assigned1==1) " >
									or
								</if>
								 (m.taskdistribution=3  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							
							
							
							<!-- 三级审批　二级审批无指派策略或是终审时 -->
							<if  test="(item==3 and assigned2!=1) " >
								 m.taskdistribution =3
							</if>
							<!-- 三级审批，二审指派的 --> 
							<if  test="item==3 and assigned2==1" >
								<if  test="(item==3 and assigned2!=1) " >
									or 
								</if>
								 (m.taskdistribution=3  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							<!-- 三级审批通过，未指派 --> 
							<if  test="item==3 and assigned3==1" >
								<if  test="(item==3 and assigned2!=1) or (item==3 and assigned2==1) " >
									or 
								</if>
								 (m.taskdistribution=4  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							
							
							<!-- 四级审批　三级审批无指派策略或是终审时 -->
							<if  test="(item==4 and assigned3!=1) " >
								 m.taskdistribution =4
							</if>
							<!-- 四级审批，三审指派的 --> 
							<if  test="item==4 and assigned3==1" >
								<if  test="(item==4 and assigned3!=1) " >
									or
								</if>
								 (m.taskdistribution=4  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							<!-- 四级审批通过，未指派 --> 
							<if  test="item==4 and assigned4==1" >
								<if  test="(item==4 and assigned3!=1) or (item==4 and assigned3==1) " >
									or 
								</if>	
								 (m.taskdistribution=5  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							
							
							
							
							<!-- 五级审批　四级审批无指派策略或是终审时 -->
							<if  test="(item==5 and assigned4!=1) " >
								 m.taskdistribution =5
							</if>
							<!-- 五级审批，四审指派的 --> 
							<if  test="item==5 and assigned4==1" >
								<if  test="(item==5 and assigned4!=1) " >
									or
								</if>
								 (m.taskdistribution=5  and m.(m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
							</if>
							
							
							
						</if>
						
						)
					</foreach>
				 </if>
			  </if>
			  
			  <if test="actiontype!=null and actiontype!='' and actiontype!=1">
				  
				  <if test="taskList != null and taskList.size()>0" >
					  AND m.taskdistribution  IN  
					<foreach collection="taskList" item="item" open="(" separator="," close=")">
						#{item}
					</foreach>
				 </if>
			 </if>
			
			
				AND m.examinestatus = 0
				<if test="actiontype!=null and actiontype!='' and actiontype!=4">
					<if test="category_code!=null and category_code!='' ">
						and m.category_id in (${category_code})
					</if>
				</if>
				
				<!-- <if test="category_id!=null and category_id!=''">
				 and  m.category_id = #{category_id}  
			  </if> -->
		   </where>
           order by m.taskdistribution,m.submittime desc
    </select>
    
    
    <select id="getTotalTime"  resultType="java.lang.String"    parameterType="com.besto.tms.vo.ExamineVO" >
    		<if test="actiontype!=null and actiontype!='' and actiontype==4">
				SELECT  SEC_TO_TIME_MY(IFNULL(SUM(cc.timelength),0)) as timelength   from (
			</if>
			<if test="actiontype!=4">
				SELECT  SEC_TO_TIME_MY(IFNULL(SUM(pro.timelength),0)) as timelength   from (
			</if>
    			SELECT DISTINCT m.provider AS providerid,m.primaryid,m.examinecorrelateid,m.examinecorrelatetype,m.userid,m.submittime,
    		                m.taskdistribution,m.examinetype,m.examinestatus,m.downobjection,m.assignStatus,m.displayuserid, m.displayusername,
				    		<if test="actiontype!=null and actiontype!='' and actiontype==4">
								pro.timelength,
							</if>
    		                m.series_id,m.playurls,m.provider FROM (
	        	select m.*,'0' as series_id,v.playurl as playurls,cm.category_id,c.provider from (SELECT * from ma_examine m2 where m2.examinecorrelatetype != 9 and m2.examinestatus=0 ) m left outer join ma_programmoviemapping p on m.examinecorrelateid = p.program_id
	        	left outer join ma_movie v on p.movie_id = v.id
	        	left outer join users u on m.userid = u.userid 
				left outer join cpinfo c on u.cspid = c.cspid
				<!-- 点播内容 -->
				<if test="actiontype!=null and actiontype!='' and actiontype==1">
				 left outer join ma_categoryprogrammapping cm on cm.program_id=m.examinecorrelateid
				 left outer join ma_category cate on cm.category_id=cate.id
	<!-- 			 LEFT OUTER JOIN ma_program pro ON pro.id =m.examinecorrelateid	 -->
					<!-- UNION ALL 子集审核信息 -->
					UNION ALL
					SELECT m.*,v1.playurl AS playurls, cm1.category_id,c1.provider<!-- ,IFNULL(pro1.timelength,0) as timelength  --> from 
					(SELECT m1.*,sp.series_id from ma_examine m1,ma_seriesprogrammapping sp where m1.examinecorrelateid=sp.program_id and m1.examinecorrelatetype=9 and m1.examinestatus = 0 ) m
					LEFT OUTER JOIN ma_programmoviemapping p1 ON m.examinecorrelateid = p1.program_id
					LEFT OUTER JOIN ma_movie v1 ON p1.movie_id = v1.id
					LEFT OUTER JOIN users u1 ON m.userid = u1.userid
					LEFT OUTER JOIN cpinfo c1 ON u1.cspid = c1.cspid
					LEFT OUTER JOIN ma_categoryprogrammapping cm1 ON cm1.program_id = m.series_id 
					LEFT OUTER JOIN ma_category cate1 ON cm1.category_id = cate1.id
	<!-- 			 	LEFT OUTER JOIN ma_program pro1 ON pro1.id =m.examinecorrelateid -->
				 
				</if>
				<!-- 直播、广播内容 -->
				<if test="actiontype!=null and actiontype!='' and (actiontype==2 or actiontype==6)">
					left outer join ma_categorychannelmapping cm on cm.channel_id=m.examinecorrelateid
					left outer join ma_category cate on cm.category_id=cate.id
					<!-- 为了显示时长 -->
					<!-- LEFT OUTER JOIN ma_program pro ON pro.id =m.examinecorrelateid -->
				</if>
				<!-- 节目单 -->
				<if test="actiontype!=null and actiontype!='' and (actiontype==3 or actiontype==7)">
					left outer join ma_categoryschedulemapping cm on cm.schedule_id=m.examinecorrelateid
					left outer join ma_category cate on cm.category_id=cate.id
					<!-- 为了显示时长 -->
					<!-- LEFT OUTER JOIN ma_program pro ON pro.id =m.examinecorrelateid -->
				</if>
				<!-- 分类管理 -->
				<if test="actiontype!=null and actiontype!='' and actiontype==4">
					left outer join ma_category cate on cate.primaryid=m.examinecorrelateid 
					left outer join (select cc.id as category_id,cc.primaryid from ma_category cc) cm on cm.primaryid=cate.parentid 
					<!-- 为了显示时长 -->
					<!-- LEFT OUTER JOIN (select 1 as id,0 as timelength from dual) pro ON pro.id =m.examinecorrelateid -->
				</if>
				) m
	
				<if test="actiontype!=null and actiontype!='' and actiontype==4">
					LEFT OUTER JOIN (select 1 as id,0 as timelength,'' AS providerid from dual) pro ON pro.id =m.examinecorrelateid
				</if>
									
	        	<where>
	        	   1=1 
	        	   <if test="actiontype!=null and actiontype!='' and actiontype==1">
	        	   		and m.examinecorrelatetype in ('1','2','9')
	        	   </if>
	        	   <if test="actiontype!=null and actiontype!='' and actiontype==2">
	        	   		and m.examinecorrelatetype in ('0','3')
	        	   </if>
	        	   <if test="actiontype!=null and actiontype!='' and actiontype==3">
	        	   		and m.examinecorrelatetype='8'
	        	   </if>
	        	    <if test="actiontype!=null and actiontype!='' and actiontype==4">
	        	   		and m.examinecorrelatetype in ('4','5','6','7')
	        	   </if>
	        	   
	        	   <!-- 内容审核 -->
	        	   <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='content' ">
	        	   		and m.examinetype in ('4')
	        	   </if>
	        	   <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='work' ">
	        	   		and m.examinetype in ('0','1','2','3')
	        	   </if>
	        	    <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='all' ">
	
	        	   </if>
	        	   <if test="dataexaminetype!=null and dataexaminetype!='' and dataexaminetype=='not' ">
						and m.examinetype in ('-1')
	        	   </if>
	        	   
				  <!-- 动态拼接条件 注意like 查询 符号变化   -->
				  <if test="cspids!=null and cspids!='MAS' and cspids!=''">
					 AND  pro.providerid = #{cspids}  
				  </if>
				  <if test="username!=null and username!='' ">
					 and  m.username like '%${username}%' ESCAPE'|' 
				  </if>
				  <if test="title!=null and title!='' ">
					 and  m.title like  '%${title}%' ESCAPE'|' 
				  </if>
				  <if  test="submitstarttime!=null and submitstarttime!='' ">
				     <![CDATA[ AND m.submittime >= #{submitstarttime,jdbcType=VARCHAR} ]]> 
				  </if>
				  <if test="submitendtime!=null and submitendtime!=''">
				     <![CDATA[ AND m.submittime <=  #{submitendtime,jdbcType=VARCHAR}  ]]> 
				  </if>
				  <!-- 点播指派 -->
				  <if test="actiontype!=null and actiontype!='' and actiontype==1">
					
					
					<if test="assignstatus!=null and assignstatus!='' ">
						<if test="assignstatus!=null and assignstatus!=3">
							AND ( m. assignstatus!=3 or isNULL( m. assignstatus))
						</if>
						<if test="assignstatus!=null and assignstatus==3">
					 		AND m. assignstatus=3
					 	</if>
				  	</if>
					
					
					
					
					
				  	 <if test="taskList != null and taskList.size()>0" >
						AND
						<foreach collection="taskList" item="item" open="(" separator="or" close=")">
							(  
							 <if test="item!=null and item!='' and level>= item ">
								<!-- 各级审批无指派策略时 -->
								<!-- 一级审批无指派策略或是终审时 -->
								<if  test="(item==1) " >
									 m.taskdistribution =1
								</if>
								<!-- 一级审批通过，未指派 --> 
								<if  test="item==1 and assigned1==1 " >
									 or (m.taskdistribution=2  and (m.assignStatus !=3 or ISNULL(m.assignstatus)) and displayuserid=#{handling_userid} )  
								</if>
								
	
	
								<!-- 二级审批    一级审批无指派策略或是终审时 -->
								<if  test="(item==2 and assigned1!=1) " >
									 m.taskdistribution =2
								</if>
								<!-- 二级审批，一审指派的 --> 
								<if  test="item==2 and assigned1==1 " >
									<if  test="(item==2 and assigned1!=1) " >
									or
									</if>	
									 (m.taskdistribution=2  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
								</if>
								<!-- 二级审批通过，未指派 --> 
								<if  test="item==2 and assigned2==1 " >
									<if  test="(item==2 and assigned1!=1)  or (item==2 and assigned1==1) " >
										or
									</if>
									 (m.taskdistribution=3  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
								</if>
								
								
								
								<!-- 三级审批　二级审批无指派策略或是终审时 -->
								<if  test="(item==3 and assigned2!=1) " >
									 m.taskdistribution =3
								</if>
								<!-- 三级审批，二审指派的 --> 
								<if  test="item==3 and assigned2==1" >
									<if  test="(item==3 and assigned2!=1) " >
										or 
									</if>
									 (m.taskdistribution=3  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
								</if>
								<!-- 三级审批通过，未指派 --> 
								<if  test="item==3 and assigned3==1" >
									<if  test="(item==3 and assigned2!=1) or (item==3 and assigned2==1) " >
										or 
									</if>
									 (m.taskdistribution=4  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
								</if>
								
								
								<!-- 四级审批　三级审批无指派策略或是终审时 -->
								<if  test="(item==4 and assigned3!=1) " >
									 m.taskdistribution =4
								</if>
								<!-- 四级审批，三审指派的 --> 
								<if  test="item==4 and assigned3==1" >
									<if  test="(item==4 and assigned3!=1) " >
										or
									</if>
									 (m.taskdistribution=4  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
								</if>
								<!-- 四级审批通过，未指派 --> 
								<if  test="item==4 and assigned4==1" >
									<if  test="(item==4 and assigned3!=1) or (item==4 and assigned3==1) " >
										or 
									</if>	
									 (m.taskdistribution=5  and (m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
								</if>
								
								
								
								
								<!-- 五级审批　四级审批无指派策略或是终审时 -->
								<if  test="(item==5 and assigned4!=1) " >
									 m.taskdistribution =5
								</if>
								<!-- 五级审批，四审指派的 --> 
								<if  test="item==5 and assigned4==1" >
									<if  test="(item==5 and assigned4!=1) " >
										or
									</if>
									 (m.taskdistribution=5  and m.(m.assignStatus !=3 or ISNULL(m.assignstatus))  and displayuserid=#{handling_userid} )  
								</if>
								
								
								
							</if>
							
							)
						</foreach>
					 </if>
				  </if>
				  
				  <if test="actiontype!=null and actiontype!='' and actiontype!=1">
					  
					  <if test="taskList != null and taskList.size()>0" >
						 AND  m.taskdistribution  IN  
						<foreach collection="taskList" item="item" open="(" separator="," close=")">
							#{item}
						</foreach>
					 </if>
				 </if>
				
				
					AND m.examinestatus = 0
					<if test="category_code!=null and category_code!='' ">
						and m.category_id in (${category_code})
					</if>
					
					<!-- <if test="category_id!=null and category_id!=''">
					 and  m.category_id = #{category_id}  
				  </if> -->
			   </where>
			   ) cc 
			   	<if test="actiontype!=null and actiontype!='' and actiontype!=4">
					LEFT OUTER JOIN ma_program pro ON pro.id =cc.examinecorrelateid
				</if>
	           <!--order by cc.taskdistribution,cc.submittime desc-->
    </select>
    
    
    
    
    
    
    
    
    
    <update id="updateTaskdistributionAndExaminestatus" >
    update ma_examine set taskdistribution = #{taskdistribution,jdbcType=VARCHAR},examinestatus = #{examinestatus,jdbcType=VARCHAR}
    where primaryid = #{primaryid,jdbcType=VARCHAR}
  </update>
  
  <select id="selectByPrimaryId" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from ma_examine
    where examinecorrelateid = #{examinecorrelateid,jdbcType=VARCHAR}
    order by primaryid desc
  </select>
  
  <!-- 更新谁人可见 -->
  <update id="updateExaminesUser" >
    update ma_examine set displayuserid = #{userid,jdbcType=VARCHAR},displayusername = #{username,jdbcType=VARCHAR}
    where primaryid = #{primaryid,jdbcType=VARCHAR}
  </update>
  
    <select id="getValidationAssignCount" resultType="java.lang.Integer" parameterType="java.lang.String">   
  	SELECT count(*) FROM ma_examineassign a WHERE a.programid=#{examineid,jdbcType=VARCHAR} AND a.assignstatus='3' AND a.isend='0'
  	</select>
  
  
  
  
  
</mapper>